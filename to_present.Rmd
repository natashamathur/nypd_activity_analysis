---
title: "Exploring NYPD activity from 2009 - 2016"
author: "Natasha Mathur"
output:
  html_document: 
    code_folding: hide
    df_print: paged 
---
```{r, include=FALSE, echo=FALSE}
library(here)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(ggmosaic)
options(scipen=10000)
options(warn=-1)
library(extrafont)
library(sf)
knitr::opts_chunk$set(
	echo = TRUE,
	fig.height = 5.3,
	fig.width = 8,
	fig.align = "center",
	message = FALSE,
	warning = FALSE,
	cache = TRUE,
	font = 'Courier New'
)
setwd("/Users/natashamathur/Documents/Winter2019/data_viz/geospatial")
```

```{r}  
ncm_colors <- c("#C732D5", "#8AC437", "#F65D3A","#4369EB", "#32D59B", "#EDA03C")
ncm_colors_names <- c('Purple', 'Green', 'Orange', 'Blue', 'Teal', 'Yellow')
ncm_colors_wgrey <- c("#C732D5", "#8AC437", "#F65D3A","#4369EB", "#32D59B", "#EDA03C", "#F4F4F4")
ncm_highlight <-c("#C732D5")
ncm_neutral <- c("#F4F4F4")
ncm_gray <- c("#DBDBDB")
ncm_compliment <- c("#32D59B")
ncm_font <- "Courier New"
ncm_font2 <- "Tahoma"
ncm_theme <- theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, face = "bold", size=14), 
        plot.subtitle = element_text(hjust=0.5, size=11, family=ncm_font2), 
        plot.caption = element_text(hjust=1, family=ncm_font2),
        panel.background = element_rect(fill = "white"),
        text=element_text(family=ncm_font), 
        axis.ticks=element_blank(), axis.text = element_text(size=10, family=ncm_font2),            
        axis.title=element_text(size=12, face="bold"),
        strip.background = element_rect(fill=ncm_gray), strip.text = element_text(color="black", family=ncm_font2, size=10), 
        legend.key=element_blank(), legend.position="none", legend.text = element_text(family=ncm_font2, size=11),
        legend.title=element_text(family=ncm_font, face="bold"))

# line break between subtitle/title (whichever is lower) and top of graph
# line break between bottom axis and x title
ann_specs <- c(family=ncm_font, fontface=2, color="white")
gl_specs <- c(color=ncm_neutral, linetype="dashed") 
```

### Stop, Question, and Frisk

Stop and Frisk is a NYPD policy that was mainly started under Police Commissioner William Bratton. It was based on an idea introduced in the 1982 "broken windows" paper by social scientists James Q. Wilson and George L. Kelling. Their analysis suggested that cracking down on small crimes like vandalism would help reduce the occurence of more serious ones. The policy allows police officers to stop, question, and search people without a warrant or suspicion of a crime. 

The number of stops peaked in 2011, along with public outrage about the practice. The policy was heavily criticized for the high amount of force used, the lack of evidence that it improved safety, and most importantly, the fact that most of the people stopped were black or hispanic. Neither the Mayor or Police Commissioner provided an adequate explanation for any of those issues. 

In May 2010 officer Adrian Schoolcraft sent the Village Voice recordings that documented orders he had received to stop, frisk, and arrest black people specifically in the Bedford-Stuyvesant neighborhood. This was concrete evidence of both the goals behind the policy and how it was carried out. Two years later protestors silently marched from lower Harlem to then-Mayor Bloomberg's house on the Upper East Side, demanding that Stop-and-Frisk be ended. That August the practice was deemed unconstitutional.  


```{r, echo=FALSE}
yr <- read.csv("sqf_year_race_8_total.csv")
yr <- transform(yr, race_w_hisp.ord  = factor( 
yr$race_w_hisp, levels=c('B', 'H', 'W', 'O', 'A'), ordered =TRUE))
yr <- yr[order(-xtfrm(yr$race_w_hisp.ord)), ]
yr$pct <- yr$pct / 1000
```

```{r, message=FALSE, warning=FALSE}
stacked_area <- ggplot(yr, aes(x = year, y=pct, , fill = race_w_hisp.ord))
stacked_area + geom_area()  + scale_fill_manual(values=ncm_colors[-6])+
  xlab("\nYear") + ylab("Number of Stops (in Thousands)\n") + 
  scale_x_continuous(breaks=seq(2009,2016,1), expand = c(0,0)) + ncm_theme + 
  scale_y_continuous(expand=c(0,0), breaks=seq(200, 800, 200)) + expand_limits(y = c(0, 1000)) +
  labs(title= "Stop-and-Frisk in New York City peaked in 2011",
       subtitle ="The practice overwhelmingly affected Black and Hispanic populations\n",
       caption="Data Source: NYPD Stop, Question, and Frisk Database") +
  geom_vline(xintercept=2010.416, color="#494949", linetype="solid") +
  geom_vline(xintercept=2012.5, colour="#494949", linetype="solid") +
  annotate("text", x = 2011.25, y = 500, label = "Black \nnon-Hispanic", family=ncm_font2, fontface=1, color="white") +
  annotate("text", x = 2011.25, y = 235, label = "Hispanic", family=ncm_font2, fontface=1, color="white") +
  annotate("text", x = 2011.45, y = 70, label = "White non-Hispanic", family=ncm_font2, fontface=1, color="white") +
  annotate("text", x = 2011.25, y = 40, label = "Other", family=ncm_font2, fontface=1, color="white") +
  annotate("text", x = 2011.25, y = 15, label = "Asian", family=ncm_font2, fontface=1, color="white") +
  geom_hline(yintercept=seq(200, 600, by=200),  colour=ncm_neutral, linetype="dashed") +
  geom_text(aes(x= 2012.55, y = 450, hjust = 0, label="March against\nStop-And-Frisk\n(June 2012)"),  color="#494949", family=ncm_font, fontface=1, size=3.5) +
  geom_text(aes(x=2010.45, y = 850, hjust=0, label="Village Voice\npublishes misconduct\nreports (May 2010)"), color="#494949", family=ncm_font, fontface=1, size=3.5) + expand_limits(y = c(0, 1000), x = c(2009, 2017)) 

```

There was much public opposition to stop and frisk, both on the grounds that it was racist and that it did not deter crime. This manifested itself through marches, speeches, demonstrations, and journalism, as well as legal means. By the time the policy was deemed unconstitutional in the end of 2013 the number of stops had already greatly decreased. 


```{r, echo=FALSE}
# read in shapefiles
borough <- read_sf(dsn = ".", layer = "nybb")
sqf_year_boro <- read.csv("sqf_map.csv")
bdf = merge(borough, sqf_year_boro, by='BoroName')
```

```{r, message=FALSE, warning=FALSE}
heatmap_all <- ggplot(data = bdf) 
heatmap_all + facet_wrap(~fct_rev(before_march))  +
    geom_sf(color=ncm_neutral, aes(fill = num_stops)) + scale_fill_gradient(low=ncm_compliment, high=ncm_highlight,
    name="Thousands of Stops", breaks=c(50,150)) + ncm_theme + 
    theme(panel.grid.major = element_line(colour = "white"), panel.grid.minor = element_blank(), axis.text = element_blank(),
    axis.title=element_blank(), legend.position = "bottom") +
    labs(title="Marked decline in stops after public protests in 2011-2012",
         subtitle="The number of Stop-and-Frisk stops was significatly lower in the year after the June 2012 march\nto Mayor Bloombergs' residence than in the year before the march\n",
        caption="Data Source: NYPD Stop, Question, and Frisk Database")
```

Police officers could stop people on the street for a variety of reasons, including fairly vagues ones such as "furtive movements" or "wearing clothing indicative of a crime". While stops were inteneded to be made based on probable-cause standards, in reality the decision making was up to the officer and their supervisors. Despite the large number of people detained on the street, few weapons of any kind were found. The number of weapons found stays relatively constant even as the number of total stops varies greatly.   


```{r, echo=FALSE}
wf <- read.csv('wf.csv')
```
```{r}
stacked_bar <- ggplot(wf, aes(fill = forcats::fct_rev(weapon_found), y=num_stops, x=year))   
stacked_bar + geom_bar(stat="identity") + xlab("\nYear") + ylab("Number of Stops (in Thousands)\n") + ncm_theme +
  theme(legend.position =c(0.85, 0.6)) +
  scale_x_continuous(breaks=seq(2009,2017,1), expand = c(0,0)) +
  scale_y_continuous(breaks=seq(0,600,200), expand = c(0,0))  +
  scale_fill_manual(values=c(ncm_highlight, "#dbdbdb"),
    name="",
    breaks=c("Y", "N"),
    labels=c("Weapon Found", "No Weapon Found")) +
 labs(title="Few weapons were ever found", 
   subtitle="Knives, pistols, assault weapons, rifles,\nand machine guns found during NYPD stops from 2009 - 2016\n",
   caption="Data Source: NYPD Stop, Question, and Frisk Database") 
```

Stop-and-frisk gave officers the power to detain anyone on the street, and to search them immediately. Previous graphs show that the majority of stops involved black or hispanic individuals. Further, whether a person was frisked once they had already been stopped also varied greatly based on race. 


```{r, echo=FALSE}
fr2 <- read.csv("fr2.csv")
```
```{r, message=FALSE, warning=FALSE}
mosaic <- ggplot(data = fr2)
mosaic +
  geom_mosaic(aes(product(race_w_hisp), fill=race_w_hisp,alpha=frisked), na.rm=TRUE) +
  scale_alpha_discrete(range=c(0.25, 1))+
  ncm_theme + theme(axis.text = element_blank()) + scale_fill_manual(values=ncm_colors) +
  xlab('Stop-and-frisk stops') + ylab("Percentage Frisked") + 
  labs(title="Black and Hispanic people were\nboth stopped and frisked more often.", 
       subtitle="People who were stopped from 2009 - 2016 by race/ethnicity\n",
       caption="Data Source: NYPD Stop, Question, and Frisk Database") +
  annotate("text", x = .26, y = .75, label = "Black non-Hispanic\n\n58% frisked",family=ncm_font, fontface=2, color="white") +
  annotate("text", x = .68, y = .75, label = "Hispanic\n\n59% frisked", family=ncm_font, fontface=2, color="white") +
  annotate("text", x = .92, y = .75, label = "Other\n(incl.\nWhite)\n\n47% frisked", family=ncm_font, size = 3.5,fontface=2,
    color="white") 
```

### Arrests by and Complaints made to the NYPD 

As in any major city, crimes take place in NYC at almost all times of day or night. When a crime is reported the exact time, date, and location of the occurence is noted, along with other information. More crimes happen between about 3pm to 7pm in the evening, and around noon. The number of crimes is also higher in the springtime, from March to June, than at other times of the year. 


```{r, echo=FALSE}
ct <- read.csv("ct.csv")
```
```{r, message=FALSE, warning=FALSE}
heatmap <- ggplot(ct, aes(Hour, Month)) 
heatmap + geom_tile(aes(fill = Crimes.Called.In)) + 
  scale_fill_gradient(low=ncm_compliment, high=ncm_highlight, name="Crimes Reported") +
  xlab("\nTime Crime Occurred") + ylab("") + 
  scale_y_continuous(breaks=c(2,4,6,8,10,12), expand=c(0,0), 
      labels=c("Feb", "Apr","June","Aug","Oct", "Dec")) +
  scale_x_continuous(breaks=c(0,4,8,12,16,20), expand=c(0,0),
      labels=c("Midnight", "4 a.m.", "8 a.m.", "12 p.m.", "4 p.m.", "8 p.m.")) +
  labs(title="More crimes take place during\nthe evening and in the springtime", 
       subtitle="Dates and times crimes occur (2009 - 2016)\n",
      caption="Data Source: NYC Open Data Complaints Data")  + ncm_theme +
  theme(legend.position = "right") +
  geom_rect(xmin = 14.5, xmax = 18.5, ymin = 2.5, ymax = 6.5, fill=NA, size = 1, color="lightgrey", alpha = .2) +
  geom_segment(x = 4, xend=4, y = 0, yend=1, color=ncm_neutral, size=0.1) +
  geom_segment(x = 8, xend=8, y = 0, yend=1, color=ncm_neutral, size=0.1) +
  geom_segment(x = 12, xend=12, y = 0, yend=1, color=ncm_neutral, size=0.1) +
  geom_segment(x = 16, xend=16, y = 0, yend=1, color=ncm_neutral, size=0.1) +
  geom_segment(x = 20, xend=20, y = 0, yend=1, color=ncm_neutral, size=0.1) +
  geom_segment(x = 0, xend=1, y = 2, yend=2, color=ncm_neutral, size=0.1) +
  geom_segment(x = 0, xend=1, y = 4, yend=4, color=ncm_neutral, size=0.1) +
  geom_segment(x = 0, xend=1, y = 6, yend=6, color=ncm_neutral, size=0.1) +
  geom_segment(x = 0, xend=1, y = 8, yend=8, color=ncm_neutral, size=0.1) +
  geom_segment(x = 0, xend=1, y = 10, yend=10, color=ncm_neutral, size=0.1) +
  geom_segment(x = 0, xend=1, y = 12, yend=12, color=ncm_neutral, size=0.1)
```

The next topic I was interested in was which crimes were the most common in NYC. A question that quickly came up was how to measure that - by the number of complaints or the number of actual arrests. This discrepancy varies greatly from crime to crime. Charges of "harassment 2" make up almost 15% of reported crimes to the NYPD but there are very few arrests for that offense. In contrast "dangerous drugs" account for about 5% of complaints called in but 18% of arrests. 


```{r, echo=FALSE}
acd <- read.csv("g5.csv")
acd$Percentage <- acd$perc * 100
```
```{r}
paired_dot <- ggplot(acd, aes(x=rank, y=Percentage, color=type))
paired_dot + geom_line(aes(group=rank), color="darkgrey", alpha=.6, size=2) +
geom_point(alpha=1, size=4) +
  scale_color_manual(values=c("#C732D5", "#32D59B", "#C732D5", "#32D59B"),
                     name="",
                        breaks=c('complaint', 'arrest'),
                        labels=c("Complaints", "Arrests")) +
ncm_theme+ theme(legend.position = "top") +
  scale_x_continuous( breaks=c(1,2,3,4,5,6), labels=c("Harassment 2", "Petit\nLarceny", "Criminal\nMischief", "Traffic\nLaws", "Theft\n(Other)", "Dangerous\nDrugs")) + 
  scale_y_continuous(breaks=c(0,5,10,15,20,25)) + xlab("") + ylab("Percentage\n") +
  labs(title="The most-reported crimes do not\nmake up the largest share of arrests",
              subtitle="Offenses by share of total complaints/arrests 2013 - 2016",
       caption="Data Source: NYC Open Data Complaints and Arrests Data") +  expand_limits(x = c(1,6.2)) +
  annotate("text", x = 1.3, y = 17, label = "More\nComplaints",family=ncm_font, fontface=2, color="#32D59B") +
  annotate("text", x =5, y = 17, label = "More\nArrests",family=ncm_font, fontface=2, color="#C732D5") 
  
```

